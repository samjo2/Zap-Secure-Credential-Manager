{% extends "base.html" %} {% block content %}
<h1>Welcome to Zap</h1>
{% if 'user' in session %}
<p>Hello, {{ session['user'] }}!</p>
<h2>Your Credentials</h2>
<div id="credentials"></div>
<h2>Add New Credential</h2>
<form id="add-credential-form">
    <input type="text" name="service" placeholder="Service" required>
    <input type="text" name="username" placeholder="Username" required>
    <input type="password" name="password" id="password" placeholder="Password" required>
    <button type="submit">Add Credential</button>
</form>
<button id="generate-password">Generate Secure Password</button> {% else %}
<p>Please log in to manage your credentials.</p>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const credentialsDiv = document.getElementById('credentials');
        const addCredentialForm = document.getElementById('add-credential-form');
        const generatePasswordBtn = document.getElementById('generate-password');
        const passwordInput = document.getElementById('password');

        // Function to fetch and display credentials
        function fetchCredentials() {
            fetch('/get_credentials')
                .then(response => response.json())
                .then(data => {
                    credentialsDiv.innerHTML = '';
                    for (const [service, cred] of Object.entries(data)) {
                        credentialsDiv.innerHTML += `
                        <div class="credential">
                            <strong>${service}</strong>:
                            Username: ${cred.username},
                            Password: <span class="password-mask">${'*'.repeat(cred.password.length)}</span>
                            <span class="password-plain" style="display:none;">${cred.password}</span>
                            <button class="toggle-password">Show</button>
                        </div>
                    `;
                    }
                    document.querySelectorAll('.toggle-password').forEach(button => {
                        button.addEventListener('click', function() {
                            togglePassword(this);
                        });
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function togglePassword(button) {
            const credentialDiv = button.closest('.credential');
            const maskSpan = credentialDiv.querySelector('.password-mask');
            const plainSpan = credentialDiv.querySelector('.password-plain');
            const isHidden = maskSpan.style.display === 'none';
            maskSpan.style.display = isHidden ? 'inline' : 'none';
            plainSpan.style.display = isHidden ? 'none' : 'inline';
            button.textContent = isHidden ? 'Show' : 'Hide';
        }

        // Fetch credentials on page load
        fetchCredentials();

        // Handle form submission
        addCredentialForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(addCredentialForm);
            fetch('/add_credential', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    fetchCredentials(); // Refresh the credentials list
                    addCredentialForm.reset(); // Clear the form
                })
                .catch(error => console.error('Error:', error));
        });

        // Generate password
        generatePasswordBtn.addEventListener('click', function() {
            fetch('/generate_password')
                .then(response => response.json())
                .then(data => {
                    passwordInput.value = data.password;
                })
                .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endblock %}
